<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mock Debate Chatbot + Live Vote Counter</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa6b2;color-scheme:dark}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071029 0%,#071827 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#e6eef6}
    .app{max-width:1100px;margin:18px auto;padding:18px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:rgba(255,255,255,0.02);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    h1{font-size:20px;margin:0 0 10px 0}
    .chat{height:540px;display:flex;flex-direction:column}
    .messages{flex:1;overflow:auto;padding:8px;gap:8px;display:flex;flex-direction:column}
    .input{display:flex;gap:8px;margin-top:10px}
    textarea{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#012;cursor:pointer}
    .claim{padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
    .votepanel{display:flex;flex-direction:column;gap:8px}
    .big{font-size:36px;font-weight:700}
    .projector{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000}
    .projector .content{color:#fff;text-align:center}
    .bigbtn{font-size:20px;padding:14px}
    .tag{display:inline-block;padding:6px 8px;background:rgba(255,255,255,0.03);border-radius:999px;font-size:13px}
    .admin{display:flex;gap:8px;align-items:center}
    a.link{color:var(--accent)}
    footer{margin-top:10px;color:var(--muted);font-size:13px}
    .valid-badge{padding:6px 8px;border-radius:999px;font-size:13px}
    .valid{background:rgba(16,185,129,0.12);color:#10b981}
    .invalid{background:rgba(239,68,68,0.12);color:#ef4444}
    .unsure{background:rgba(234,179,8,0.12);color:#eab308}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Mock Debate Chatbot — Rahul Gandhi vs Narendra Modi (classroom edition)</h1>
      <div class="muted">Collect claims and let the moderator mark if each point is valid for the team's cause (no links required).</div>
      <hr />
      <div style="display:flex;gap:10px;margin-bottom:8px;">
        <select id="teamSelect"><option value="Rahul Gandhi / Congress">Team A — Rahul Gandhi side</option><option value="Narendra Modi / BJP">Team B — Narendra Modi side</option></select>
        <input id="speaker" placeholder="Speaker name (e.g., Ayaan)" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit" />
      </div>
      <div class="chat">
        <div class="messages" id="messages"></div>
        <div class="input">
          <textarea id="claimInput" rows="2" placeholder="Paste a claim or point (e.g., 'ECI used fake logins to delete voters in Mahadevapura')"></textarea>
          <button id="addClaim">Add Claim</button>
        </div>
      </div>
      <hr />
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small muted">Claims board — click a claim to mark Valid / Invalid / Unsure</div>
          <div>
            <button id="openProjector" class="bigbtn">Open Projector View</button>
          </div>
        </div>
        <div class="list" id="claimsList"></div>
      </div>
      <footer>Moderator marks whether a claim actually supports their team's argument — this avoids needing external evidence during class demos.</footer>
    </div>

    <div class="card">
      <h1>Vote Counter (live)</h1>
      <div class="votepanel">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <div class="small muted">Team A</div>
            <div id="teamAName" class="big">Rahul Gandhi / Congress</div>
            <div id="teamACount" class="big">0</div>
          </div>
          <div style="flex:1">
            <div class="small muted">Team B</div>
            <div id="teamBName" class="big">Narendra Modi / BJP</div>
            <div id="teamBCount" class="big">0</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="voteA">Vote Team A</button>
          <button id="voteB">Vote Team B</button>
          <button id="resetVotes">Reset</button>
          <button id="downloadCSV">Export CSV</button>
        </div>
        <div class="muted small">Open this same file on your projector and click "Projector View" for fullscreen results. Votes sync across tabs/windows on the same browser (BroadcastChannel).</div>
      </div>
      <hr />
        <div class="admin card">
          <div style="display:flex;flex-direction:column;gap:8px;width:100%">
            <div class="small muted">Google Custom Search API Configuration:</div>
            <input id="googleApiKey" placeholder="Enter your Google API Key" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit" />
            <input id="googleSearchEngineId" placeholder="Enter your Custom Search Engine ID" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit" />
            <div style="display:flex;gap:8px;">
              <button id="testGoogleAPI" style="padding:8px;border-radius:8px;background:#22c55e;border:none;color:#fff;cursor:pointer;flex:1">Test API</button>
              <button id="verifyAllClaims" style="padding:8px;border-radius:8px;background:var(--accent);border:none;color:#012;cursor:pointer;flex:2">Verify All Claims</button>
            </div>
            <div class="small muted">Get your API key from <a href="https://developers.google.com/custom-search/v1/introduction" target="_blank" class="link">Google Custom Search API</a> and create a search engine at <a href="https://cse.google.com/" target="_blank" class="link">Google CSE</a>.</div>
          </div>
        </div>
    </div>
  </div>

  <div class="projector" id="projector">
    <div class="content">
      <div style="font-size:28px;margin-bottom:6px">Live Result — Mock Debate</div>
      <div style="display:flex;gap:40px;align-items:center;justify-content:center">
        <div>
          <div class="tag">Team A</div>
          <div id="projA" class="big">0</div>
        </div>
        <div>
          <div class="tag">Team B</div>
          <div id="projB" class="big">0</div>
        </div>
      </div>
      <div id="projWinner" style="margin-top:18px;font-size:22px"></div>
      <div style="margin-top:20px;font-size:13px;color:#9aa6b2">Press ESC to exit projector mode.</div>
    </div>
  </div>

  <script>
  // --- DOM Elements ---
  const messagesEl = document.getElementById('messages')
  const claimsList = document.getElementById('claimsList')
  const claimInput = document.getElementById('claimInput')
  const addClaimBtn = document.getElementById('addClaim')
  const teamSelect = document.getElementById('teamSelect')
  const speaker = document.getElementById('speaker')
  const googleApiKeyEl = document.getElementById('googleApiKey')
  const googleSearchEngineIdEl = document.getElementById('googleSearchEngineId')
  const testGoogleAPI = document.getElementById('testGoogleAPI')
  const verifyAllClaims = document.getElementById('verifyAllClaims')

  // --- State ---
  let claims = JSON.parse(localStorage.getItem('mock_claims')||'[]')
  let votes = JSON.parse(localStorage.getItem('mock_votes')||'{"A":0,"B":0}')

  // --- Save/Load ---
  function save(){
    localStorage.setItem('mock_claims',JSON.stringify(claims));
    localStorage.setItem('mock_votes',JSON.stringify(votes))
  }

  // --- Validity Badge ---
  function validityBadge(v){
    if(!v) return '<span class="valid-badge unsure">Not checked</span>'
    if(v==='checking') return '<span class="valid-badge unsure">Checking…</span>'
    if(v==='valid') return '<span class="valid-badge valid">Valid</span>'
    if(v==='invalid') return '<span class="valid-badge invalid">Invalid</span>'
    if(v==='unsure') return '<span class="valid-badge unsure">Unsure</span>'
    return '<span class="valid-badge unsure">Unknown</span>'
  }

  // --- Render Functions ---
  function renderMessages(){
    messagesEl.innerHTML='';
    claims.slice().reverse().forEach(c=>{
      const div=document.createElement('div');
      div.className='claim';
      div.innerHTML=`
        <div style="display:flex;justify-content:space-between">
          <div><strong>${c.team}</strong> — <span class="muted small">${c.speaker||'unknown'}</span></div>
          <div class="small muted">${new Date(c.ts).toLocaleString()}</div>
        </div>
        <div style="margin-top:6px">${c.text}</div>
        <div style="margin-top:8px" class="small muted">Validity: ${validityBadge(c.validity)}</div>
        ${c.checkResult ? `<div class="small muted" style="margin-top:4px">${c.checkResult}</div>` : ''}
      `;
      messagesEl.appendChild(div)
    })
  }

  function renderClaims(){
    claimsList.innerHTML='';
    claims.forEach((c,idx)=>{
      const el=document.createElement('div');
      el.className='claim';
      el.innerHTML=`
        <div style="display:flex;justify-content:space-between">
          <div><strong>${c.team}</strong> — ${c.speaker||'unknown'}</div>
          <div class="small muted">${new Date(c.ts).toLocaleString()}</div>
        </div>
        <div style="margin-top:6px">${c.text}</div>
        <div style="margin-top:8px" class="small muted">${validityBadge(c.validity)}</div>
        ${c.checkResult ? `<div class="small muted" style="margin-top:4px">${c.checkResult}</div>` : ''}
      `;
      claimsList.appendChild(el)
    })
  }

  // --- Google Custom Search API Claim Check ---
  async function checkClaimWithGoogle(claimObj) {
    claimObj.validity = 'checking';
    claimObj.checkResult = '';
    save(); renderClaims(); renderMessages();

    try {
      // New (call your Node.js proxy)
      const resp = await fetch('/api/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: claimObj.text })
      });
      const data = await resp.json();
      if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
        claimObj.validity = 'unsure';
        claimObj.checkResult = 'No relevant results found.';
      } else {
        // Simple heuristic: if a fact-checking site or news site appears, mark as valid/invalid
        const factCheckSites = [
          'snopes.com','factcheck.org','boomlive.in','altnews.in','politifact.com','thequint.com','bbc.com','reuters.com','indiatoday.in','thehindu.com'
        ];
        let foundValid = false, foundInvalid = false, foundFact = false, foundNews = false;
        let snippet = '';
        for (const item of data.items) {
          const link = item.link||'';
          const displayLink = item.displayLink||'';
          const lower = (link + ' ' + displayLink).toLowerCase();
          snippet += (item.snippet||'') + ' ';
          if (factCheckSites.some(site=>lower.includes(site))) foundFact = true;
          if (lower.includes('fake') || lower.includes('false') || lower.includes('debunk')) foundInvalid = true;
          if (lower.includes('true') || lower.includes('confirmed') || lower.includes('verified')) foundValid = true;
          if (lower.includes('news')) foundNews = true;
        }
        if (foundFact && foundInvalid) {
          claimObj.validity = 'invalid';
          claimObj.checkResult = 'Fact-checking sources suggest this claim is false.';
        } else if (foundFact && foundValid) {
          claimObj.validity = 'valid';
          claimObj.checkResult = 'Fact-checking sources support this claim.';
        } else if (foundValid) {
          claimObj.validity = 'valid';
          claimObj.checkResult = 'Multiple sources support this claim.';
        } else if (foundInvalid) {
          claimObj.validity = 'invalid';
          claimObj.checkResult = 'Multiple sources dispute this claim.';
        } else if (foundNews) {
          claimObj.validity = 'unsure';
          claimObj.checkResult = 'News sources discuss this claim, but no clear verdict.';
        } else {
          claimObj.validity = 'unsure';
          claimObj.checkResult = 'No clear evidence found.';
        }
      }
    } catch (e) {
      claimObj.validity = 'unsure';
      claimObj.checkResult = 'Error checking claim: ' + e.message;
    }
    save(); renderClaims(); renderMessages();
  }

  // --- Add Claim ---
  addClaimBtn.onclick=()=>{
    const txt = claimInput.value.trim();
    if(!txt) return;
    const claim = {
      team: teamSelect.value,
      speaker: speaker.value||'',
      text: txt,
      ts: Date.now(),
      validity: '',
      checkResult: ''
    };
    claims.push(claim);
    claimInput.value='';
    save(); renderClaims(); renderMessages();
    // Automatically check claim with Google
    checkClaimWithGoogle(claim);
  }

  // --- Verify All Claims Button ---
  verifyAllClaims.onclick = async () => {
    for (const claim of claims) {
      if (!claim.validity || claim.validity === 'unsure') {
        await checkClaimWithGoogle(claim);
      }
    }
  };

  // --- Test API Button ---
  testGoogleAPI.onclick = async () => {
    const apiKey = googleApiKeyEl.value.trim();
    const cx = googleSearchEngineIdEl.value.trim();
    if (!apiKey || !cx) {
      alert('Please enter both API Key and Search Engine ID.');
      return;
    }
    try {
      const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=test`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('API error');
      const data = await resp.json();
      if (data.items && data.items.length > 0) {
        alert('API test succeeded!');
      } else {
        alert('API test did not return results. Check your Search Engine ID.');
      }
    } catch (e) {
      alert('API test failed: ' + e.message);
    }
  };

  // --- Votes using BroadcastChannel for live sync across tabs ---
  const chan = ('BroadcastChannel' in window) ? new BroadcastChannel('mock-debate-votes') : null
  function broadcast(){ if(chan) chan.postMessage({type:'votes',votes}) }
  if(chan){chan.onmessage = (ev)=>{ if(ev.data && ev.data.type==='votes'){ votes = ev.data.votes; save(); renderVotes(); } }}

  document.getElementById('voteA').onclick=()=>{ votes.A++; save(); broadcast(); renderVotes(); }
  document.getElementById('voteB').onclick=()=>{ votes.B++; save(); broadcast(); renderVotes(); }
  document.getElementById('resetVotes').onclick=()=>{ if(confirm('Reset votes?')){ votes={A:0,B:0}; save(); broadcast(); renderVotes(); } }

  function renderVotes(){
    document.getElementById('teamACount').innerText = votes.A
    document.getElementById('teamBCount').innerText = votes.B
    document.getElementById('projA').innerText = votes.A
    document.getElementById('projB').innerText = votes.B
    document.getElementById('projWinner').innerText = votes.A===votes.B? 'Tie' : (votes.A>votes.B? 'Team A leading' : 'Team B leading')
  }

  document.getElementById('downloadCSV').onclick=()=>{
    const rows = [['Team','Votes'],['Team A ('+document.getElementById('teamAName').innerText+')',votes.A],['Team B ('+document.getElementById('teamBName').innerText+')',votes.B]]
    const csv = rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\r\n')
    const blob = new Blob([csv],{type:'text/csv'})
    const a = document.createElement('a')
    a.href = URL.createObjectURL(blob)
    a.download = 'votes.csv'
    a.click()
  }

  // --- On Load: restore API keys if present ---
  window.addEventListener('DOMContentLoaded',()=>{
    googleApiKeyEl.value = localStorage.getItem('google_api_key') || '';
    googleSearchEngineIdEl.value = localStorage.getItem('google_search_engine_id') || '';
    googleApiKeyEl.onchange = () => localStorage.setItem('google_api_key', googleApiKeyEl.value.trim());
    googleSearchEngineIdEl.onchange = () => localStorage.setItem('google_search_engine_id', googleSearchEngineIdEl.value.trim());
    renderClaims(); renderMessages(); renderVotes();
  });

  // --- Projector View ---
  async function openBigScreen(){
    const title = 'Mock Debate Live Results'
    var contentHTML = '<!doctype html>' +
      '<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">' +
      '<title>' + title.replace(/</g,'&lt;') + '</title>' +
      '<style>body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh}.wrap{display:flex;gap:80px;align-items:center}.big{font-size:72px;font-weight:700}.tag{font-size:18px;opacity:0.8}</style>' +
      '</head><body>' +
      '<div class="wrap"><div><div class="tag">Team A</div><div id="a" class="big">0</div></div><div><div class="tag">Team B</div><div id="b" class="big">0</div></div></div>' +
      '<script>' +
      "(function(){var bc=(typeof BroadcastChannel!=='undefined')?new BroadcastChannel('mock-debate-votes'):null;function update(v){var A=document.getElementById('a');var B=document.getElementById('b');if(A)A.innerText=v.A; if(B)B.innerText=v.B;}if(bc){bc.onmessage=function(e){if(e.data&&e.data.type==='votes')update(e.data.votes);};}try{if(window.opener&&window.opener.localStorage){var s=window.opener.localStorage.getItem('mock_votes');if(s)update(JSON.parse(s));}}catch(e){} })();"
      + '</scr' + 'ipt></body></html>'

    try{
      const bigWin = window.open('','_blank')
      if(!bigWin){ throw new Error('Popup blocked') }
      const doc = bigWin.document
      doc.open()
      doc.write(contentHTML)
      doc.close()
      return true
    }catch(err){
      console.warn('openBigScreen failed:',err)
      document.getElementById('projector').style.display='flex'
      return false
    }
  }

  document.getElementById('openProjector').onclick=()=>{ openBigScreen() }
  window.addEventListener('keydown',e=>{ if(e.key==='Escape'){ document.getElementById('projector').style.display='none' } })

  // If the script runs before DOMContentLoaded (rare in this file), ensure initialization
  if(document.readyState!=='loading'){
    renderClaims(); renderMessages(); renderVotes();
  }
</script>
</body>
</html>
